
var histcatexplong =  [
    {
        "key" : "infrastructure",
        "values" : [[1293843600000, 65], [1296522000000, 61], [1298941200000, 50], [1301619600000, 80], [1304211600000, 58], [1306890000000, 99], [1309482000000, 76], [1312160400000, 54], [1314838800000, 59], [1317430800000, 60], [1320109200000, 62], [1322701200000, 72], [1325379600000, 68], [1328058000000, 98], [1330563600000, 74], [1333242000000, 60], [1335834000000, 87], [1338512400000, 81], [1341104400000, 76], [1343782800000, 74], [1346461200000, 57], [1349053200000, 90], [1351731600000, 81], [1354323600000, 77], [1357002000000, 123], [1359680400000, 79], [1362099600000, 76], [1364778000000, 83], [1367370000000, 63], [1370048400000, 83], [1372640400000, 104], [1375318800000, 82], [1377997200000, 80], [1380589200000, 70], [1383267600000, 79], [1385859600000, 64], [1388538000000, 79], [1391216400000, 60], [1393635600000, 63], [1396314000000, 82], [1398906000000, 83], [1401584400000, 92], [1404176400000, 107], [1406854800000, 88], [1409533200000, 82], [1412125200000, 76], [1414803600000, 80], [1417395600000, 82], [1420074000000, 72], [1422752400000, 63], [1425171600000, 89], [1427850000000, 69], [1430442000000, 76], [1433120400000, 92], [1435712400000, 101], [1438390800000, 80], [1441069200000, 85], [1443661200000, 81], [1446339600000, 72], [1448931600000, 75], [1451610000000, 90], [1454288400000, 79], [1456794000000, 79], [1459472400000, 69], [1462064400000, 94], [1464742800000, 93], [1467334800000, 127], [1470013200000, 93], [1472691600000, 110], [1475283600000, 63], [1477962000000, 99], [1480554000000, 75], [1483232400000, 110], [1485910800000, 106], [1488330000000, 79], [1491008400000, 69], [1493600400000, 119], [1496278800000, 115], [1498870800000, 81], [1501549200000, 93], [1504227600000, 125]]
    },
    {
        "key" : "engineering work",
        "values" : [[1293843600000, 7], [1296522000000, 1], [1298941200000, 18], [1301619600000, 5], [1304211600000, 13], [1306890000000, 9], [1309482000000, 9], [1312160400000, 5], [1314838800000, 9], [1317430800000, 6], [1320109200000, 16], [1322701200000, 4], [1325379600000, 9], [1328058000000, 7], [1330563600000, 6], [1333242000000, 4], [1335834000000, 6], [1338512400000, 4], [1341104400000, 7], [1343782800000, 2], [1346461200000, 3], [1349053200000, 7], [1351731600000, 21], [1354323600000, 14], [1357002000000, 8], [1359680400000, 8], [1362099600000, 8], [1364778000000, 16], [1367370000000, 9], [1370048400000, 17], [1372640400000, 13], [1375318800000, 9], [1377997200000, 19], [1380589200000, 16], [1383267600000, 43], [1385859600000, 41], [1388538000000, 55], [1391216400000, 21], [1393635600000, 24], [1396314000000, 45], [1398906000000, 25], [1401584400000, 20], [1404176400000, 26], [1406854800000, 25], [1409533200000, 15], [1412125200000, 26], [1414803600000, 39], [1417395600000, 28], [1420074000000, 34], [1422752400000, 9], [1425171600000, 33], [1427850000000, 19], [1430442000000, 23], [1433120400000, 22], [1435712400000, 25], [1438390800000, 33], [1441069200000, 32], [1443661200000, 23], [1446339600000, 25], [1448931600000, 21], [1451610000000, 18], [1454288400000, 25], [1456794000000, 23], [1459472400000, 20], [1462064400000, 18], [1464742800000, 27], [1467334800000, 21], [1470013200000, 26], [1472691600000, 21], [1475283600000, 15], [1477962000000, 27], [1480554000000, 11], [1483232400000, 13], [1485910800000, 20], [1488330000000, 14], [1491008400000, 14], [1493600400000, 18], [1496278800000, 19], [1498870800000, 20], [1501549200000, 17], [1504227600000, 16]]
    },
    {
        "key" : "unknown",
        "values" : [[1293843600000, 7], [1296522000000, 12], [1298941200000, 11], [1301619600000, 10], [1304211600000, 10], [1306890000000, 26], [1309482000000, 16], [1312160400000, 11], [1314838800000, 14], [1317430800000, 18], [1320109200000, 3], [1322701200000, 3], [1325379600000, 4], [1328058000000, 10], [1330563600000, 1], [1333242000000, 6], [1335834000000, 2], [1338512400000, 2], [1341104400000, 5], [1343782800000, 2], [1346461200000, 6], [1349053200000, 2], [1351731600000, 6], [1354323600000, 15], [1357002000000, 9], [1359680400000, 4], [1362099600000, 4], [1364778000000, 6], [1367370000000, 6], [1370048400000, 8], [1372640400000, 5], [1375318800000, 7], [1377997200000, 5], [1380589200000, 20], [1383267600000, 6], [1385859600000, 5], [1388538000000, 10], [1391216400000, 7], [1393635600000, 1], [1396314000000, 6], [1398906000000, 10], [1401584400000, 11], [1404176400000, 9], [1406854800000, 6], [1409533200000, 3], [1412125200000, 10], [1414803600000, 19], [1417395600000, 23], [1420074000000, 13], [1422752400000, 3], [1425171600000, 10], [1427850000000, 14], [1430442000000, 8], [1433120400000, 4], [1435712400000, 6], [1438390800000, 13], [1441069200000, 15], [1443661200000, 13], [1446339600000, 15], [1448931600000, 7], [1451610000000, 1], [1454288400000, 8], [1456794000000, 4], [1459472400000, 4], [1462064400000, 4], [1464742800000, 9], [1467334800000, 10], [1470013200000, 8], [1472691600000, 16], [1475283600000, 7], [1477962000000, 11], [1480554000000, 9], [1483232400000, 14], [1485910800000, 10], [1488330000000, 4], [1491008400000, 5], [1493600400000, 2], [1496278800000, 1], [1498870800000, 6], [1501549200000, 9], [1504227600000, 4]]
    },
    {
        "key" : "weather",
        "values" : [[1293843600000, 0], [1296522000000, 2], [1298941200000, 0], [1301619600000, 2], [1304211600000, 1], [1306890000000, 13], [1309482000000, 0], [1312160400000, 6], [1314838800000, 3], [1317430800000, 3], [1320109200000, 1], [1322701200000, 3], [1325379600000, 6], [1328058000000, 13], [1330563600000, 0], [1333242000000, 2], [1335834000000, 2], [1338512400000, 9], [1341104400000, 8], [1343782800000, 8], [1346461200000, 2], [1349053200000, 3], [1351731600000, 4], [1354323600000, 10], [1357002000000, 12], [1359680400000, 7], [1362099600000, 2], [1364778000000, 3], [1367370000000, 0], [1370048400000, 2], [1372640400000, 3], [1375318800000, 0], [1377997200000, 0], [1380589200000, 30], [1383267600000, 4], [1385859600000, 16], [1388538000000, 2], [1391216400000, 0], [1393635600000, 0], [1396314000000, 5], [1398906000000, 0], [1401584400000, 3], [1404176400000, 8], [1406854800000, 1], [1409533200000, 1], [1412125200000, 6], [1414803600000, 5], [1417395600000, 12], [1420074000000, 17], [1422752400000, 3], [1425171600000, 9], [1427850000000, 1], [1430442000000, 1], [1433120400000, 4], [1435712400000, 23], [1438390800000, 4], [1441069200000, 1], [1443661200000, 9], [1446339600000, 24], [1448931600000, 4], [1451610000000, 9], [1454288400000, 4], [1456794000000, 3], [1459472400000, 0], [1462064400000, 4], [1464742800000, 4], [1467334800000, 0], [1470013200000, 0], [1472691600000, 4], [1475283600000, 2], [1477962000000, 14], [1480554000000, 12], [1483232400000, 12], [1485910800000, 5], [1488330000000, 2], [1491008400000, 1], [1493600400000, 4], [1496278800000, 3], [1498870800000, 4], [1501549200000, 0], [1504227600000, 4]]
    },
    {
        "key" : "external",
        "values" : [[1293843600000, 10], [1296522000000, 4], [1298941200000, 7], [1301619600000, 11], [1304211600000, 6], [1306890000000, 16], [1309482000000, 16], [1312160400000, 11], [1314838800000, 9], [1317430800000, 16], [1320109200000, 13], [1322701200000, 17], [1325379600000, 20], [1328058000000, 21], [1330563600000, 13], [1333242000000, 14], [1335834000000, 16], [1338512400000, 18], [1341104400000, 20], [1343782800000, 15], [1346461200000, 23], [1349053200000, 12], [1351731600000, 18], [1354323600000, 13], [1357002000000, 15], [1359680400000, 6], [1362099600000, 10], [1364778000000, 20], [1367370000000, 13], [1370048400000, 18], [1372640400000, 14], [1375318800000, 18], [1377997200000, 10], [1380589200000, 20], [1383267600000, 22], [1385859600000, 27], [1388538000000, 14], [1391216400000, 9], [1393635600000, 11], [1396314000000, 19], [1398906000000, 15], [1401584400000, 12], [1404176400000, 14], [1406854800000, 18], [1409533200000, 20], [1412125200000, 20], [1414803600000, 25], [1417395600000, 23], [1420074000000, 40], [1422752400000, 24], [1425171600000, 21], [1427850000000, 24], [1430442000000, 30], [1433120400000, 23], [1435712400000, 46], [1438390800000, 24], [1441069200000, 27], [1443661200000, 28], [1446339600000, 34], [1448931600000, 28], [1451610000000, 18], [1454288400000, 13], [1456794000000, 25], [1459472400000, 16], [1462064400000, 26], [1464742800000, 24], [1467334800000, 24], [1470013200000, 14], [1472691600000, 22], [1475283600000, 24], [1477962000000, 25], [1480554000000, 16], [1483232400000, 36], [1485910800000, 32], [1488330000000, 32], [1491008400000, 39], [1493600400000, 42], [1496278800000, 46], [1498870800000, 33], [1501549200000, 27], [1504227600000, 31]]
    },
    {
        "key" : "logistical",
        "values" : [[1293843600000, 1], [1296522000000, 2], [1298941200000, 2], [1301619600000, 4], [1304211600000, 0], [1306890000000, 9], [1309482000000, 1], [1312160400000, 2], [1314838800000, 2], [1317430800000, 0], [1320109200000, 9], [1322701200000, 6], [1325379600000, 8], [1328058000000, 1], [1330563600000, 12], [1333242000000, 3], [1335834000000, 9], [1338512400000, 2], [1341104400000, 7], [1343782800000, 3], [1346461200000, 1], [1349053200000, 1], [1351731600000, 7], [1354323600000, 9], [1357002000000, 10], [1359680400000, 2], [1362099600000, 0], [1364778000000, 9], [1367370000000, 5], [1370048400000, 7], [1372640400000, 9], [1375318800000, 4], [1377997200000, 7], [1380589200000, 3], [1383267600000, 6], [1385859600000, 5], [1388538000000, 7], [1391216400000, 5], [1393635600000, 7], [1396314000000, 9], [1398906000000, 13], [1401584400000, 8], [1404176400000, 12], [1406854800000, 6], [1409533200000, 12], [1412125200000, 5], [1414803600000, 7], [1417395600000, 16], [1420074000000, 12], [1422752400000, 10], [1425171600000, 16], [1427850000000, 5], [1430442000000, 7], [1433120400000, 12], [1435712400000, 16], [1438390800000, 11], [1441069200000, 21], [1443661200000, 18], [1446339600000, 15], [1448931600000, 12], [1451610000000, 12], [1454288400000, 14], [1456794000000, 6], [1459472400000, 17], [1462064400000, 16], [1464742800000, 28], [1467334800000, 11], [1470013200000, 18], [1472691600000, 24], [1475283600000, 27], [1477962000000, 21], [1480554000000, 34], [1483232400000, 17], [1485910800000, 16], [1488330000000, 9], [1491008400000, 13], [1493600400000, 18], [1496278800000, 14], [1498870800000, 12], [1501549200000, 11], [1504227600000, 8]]
    },
    {
        "key" : "rolling stock",
        "values" : [[1293843600000, 24], [1296522000000, 18], [1298941200000, 13], [1301619600000, 16], [1304211600000, 24], [1306890000000, 20], [1309482000000, 17], [1312160400000, 20], [1314838800000, 21], [1317430800000, 29], [1320109200000, 43], [1322701200000, 19], [1325379600000, 23], [1328058000000, 42], [1330563600000, 12], [1333242000000, 28], [1335834000000, 21], [1338512400000, 18], [1341104400000, 37], [1343782800000, 28], [1346461200000, 29], [1349053200000, 32], [1351731600000, 46], [1354323600000, 22], [1357002000000, 34], [1359680400000, 29], [1362099600000, 23], [1364778000000, 25], [1367370000000, 31], [1370048400000, 28], [1372640400000, 30], [1375318800000, 35], [1377997200000, 27], [1380589200000, 35], [1383267600000, 31], [1385859600000, 38], [1388538000000, 22], [1391216400000, 23], [1393635600000, 33], [1396314000000, 21], [1398906000000, 37], [1401584400000, 37], [1404176400000, 41], [1406854800000, 30], [1409533200000, 30], [1412125200000, 43], [1414803600000, 32], [1417395600000, 61], [1420074000000, 70], [1422752400000, 43], [1425171600000, 35], [1427850000000, 46], [1430442000000, 37], [1433120400000, 34], [1435712400000, 59], [1438390800000, 53], [1441069200000, 44], [1443661200000, 54], [1446339600000, 91], [1448931600000, 46], [1451610000000, 35], [1454288400000, 58], [1456794000000, 47], [1459472400000, 40], [1462064400000, 54], [1464742800000, 66], [1467334800000, 59], [1470013200000, 57], [1472691600000, 61], [1475283600000, 69], [1477962000000, 76], [1480554000000, 88], [1483232400000, 183], [1485910800000, 115], [1488330000000, 145], [1491008400000, 117], [1493600400000, 149], [1496278800000, 131], [1498870800000, 133], [1501549200000, 100], [1504227600000, 139]]
    },
    {
        "key" : "accidents",
        "values" : [[1293843600000, 26], [1296522000000, 23], [1298941200000, 29], [1301619600000, 22], [1304211600000, 26], [1306890000000, 17], [1309482000000, 30], [1312160400000, 28], [1314838800000, 29], [1317430800000, 25], [1320109200000, 38], [1322701200000, 32], [1325379600000, 26], [1328058000000, 21], [1330563600000, 29], [1333242000000, 20], [1335834000000, 32], [1338512400000, 30], [1341104400000, 25], [1343782800000, 24], [1346461200000, 28], [1349053200000, 25], [1351731600000, 33], [1354323600000, 34], [1357002000000, 41], [1359680400000, 29], [1362099600000, 31], [1364778000000, 38], [1367370000000, 19], [1370048400000, 19], [1372640400000, 22], [1375318800000, 26], [1377997200000, 21], [1380589200000, 29], [1383267600000, 21], [1385859600000, 33], [1388538000000, 21], [1391216400000, 21], [1393635600000, 25], [1396314000000, 17], [1398906000000, 24], [1401584400000, 15], [1404176400000, 22], [1406854800000, 32], [1409533200000, 17], [1412125200000, 30], [1414803600000, 35], [1417395600000, 19], [1420074000000, 20], [1422752400000, 27], [1425171600000, 25], [1427850000000, 25], [1430442000000, 28], [1433120400000, 26], [1435712400000, 23], [1438390800000, 27], [1441069200000, 32], [1443661200000, 31], [1446339600000, 35], [1448931600000, 45], [1451610000000, 29], [1454288400000, 21], [1456794000000, 26], [1459472400000, 37], [1462064400000, 35], [1464742800000, 21], [1467334800000, 31], [1470013200000, 27], [1472691600000, 35], [1475283600000, 37], [1477962000000, 40], [1480554000000, 23], [1483232400000, 37], [1485910800000, 33], [1488330000000, 31], [1491008400000, 23], [1493600400000, 28], [1496278800000, 34], [1498870800000, 35], [1501549200000, 25], [1504227600000, 19]]
    },
    {
        "key" : "staff",
        "values" : [[1293843600000, 0], [1296522000000, 0], [1298941200000, 4], [1301619600000, 1], [1304211600000, 0], [1306890000000, 0], [1309482000000, 1], [1312160400000, 0], [1314838800000, 0], [1317430800000, 0], [1320109200000, 1], [1322701200000, 3], [1325379600000, 1], [1328058000000, 0], [1330563600000, 0], [1333242000000, 0], [1335834000000, 0], [1338512400000, 1], [1341104400000, 0], [1343782800000, 0], [1346461200000, 0], [1349053200000, 0], [1351731600000, 0], [1354323600000, 0], [1357002000000, 0], [1359680400000, 0], [1362099600000, 0], [1364778000000, 0], [1367370000000, 0], [1370048400000, 0], [1372640400000, 0], [1375318800000, 0], [1377997200000, 0], [1380589200000, 0], [1383267600000, 0], [1385859600000, 0], [1388538000000, 0], [1391216400000, 0], [1393635600000, 0], [1396314000000, 1], [1398906000000, 0], [1401584400000, 1], [1404176400000, 0], [1406854800000, 0], [1409533200000, 0], [1412125200000, 4], [1414803600000, 1], [1417395600000, 1], [1420074000000, 0], [1422752400000, 0], [1425171600000, 2], [1427850000000, 3], [1430442000000, 6], [1433120400000, 0], [1435712400000, 0], [1438390800000, 0], [1441069200000, 0], [1443661200000, 1], [1446339600000, 0], [1448931600000, 0], [1451610000000, 0], [1454288400000, 0], [1456794000000, 0], [1459472400000, 0], [1462064400000, 10], [1464742800000, 2], [1467334800000, 0], [1470013200000, 1], [1472691600000, 1], [1475283600000, 0], [1477962000000, 0], [1480554000000, 0], [1483232400000, 0], [1485910800000, 0], [1488330000000, 1], [1491008400000, 1], [1493600400000, 0], [1496278800000, 1], [1498870800000, 0], [1501549200000, 0], [1504227600000, 0]]
    }
];

var colors = d3.scale.category20();
var chart;

function throttle(fn, threshhold, scope) {
  threshhold || (threshhold = 250);
  var last,
      deferTimer;
  return function () {
    var context = scope || this;

    var now = +new Date,
        args = arguments;
    if (last && now < last + threshhold) {
      // hold on to it
      clearTimeout(deferTimer);
      deferTimer = setTimeout(function () {
        last = now;
        fn.apply(context, args);
      }, threshhold);
    } else {
      last = now;
      fn.apply(context, args);
    }
  };
}
var chooseDateExtent = throttle(function () {
    window.dateExtent = [new Date(window.timeRange[0]), new Date(window.timeRange[1])];
    chooseMapDateExtent(window.dateExtent);
    // updateHistograms(window.dateExtent[0], window.dateExtent[1], []);
  }, 500);


window.onBrushEnd = function() {
  // chooseMapDateExtent([new Date(window.timeRange[0]), new Date(window.timeRange[1])]);
};
window.onBrush = chooseDateExtent;
window.chooseTypes = function(state) {
  var types = {};
  histcatexplong.forEach(function (item, i) {
    types[item.key] = !state.disabled[i];
  });
  window.types = types;
  // chooseMapTypes(types);
  chooseMapDateExtent(window.dateExtent);
};
window.types = {};

nv.addGraph(function() {
    chart = nv.models.stackedAreaWithFocusChart()
        .useInteractiveGuideline(true)
        .x(function(d) { return d[0] })
        .y(function(d) { return d[1] })
        .controlLabels({stacked: "Stacked"})
        .duration(300);

    window.stackGraphChart = chart;

    chart.brushExtent([1293843600000, 1504227600000]);

    chart.xAxis.tickFormat(function(d) { return d3.time.format('%Y-%m-%d')(new Date(d)) });
    chart.x2Axis.tickFormat(function(d) { return d3.time.format('%Y-%m-%d')(new Date(d)) });
    chart.yAxis.tickFormat(d3.format(',.4f'));
    chart.y2Axis.tickFormat(d3.format(',.4f'));

    chart.legend.vers('furious');

    // d3.select('#stackGraphContainer')
    //     .datum(histcatexplong)
    //     .transition().duration(1000)
    //     .call(chart)
    //     .each('start', function() {
    //         setTimeout(function() {
    //             d3.selectAll('#stackGraphContainer *').each(function() {
    //                 if(this.__transition__)
    //                     this.__transition__.duration = 4;
    //             })
    //         }, 0)
    //     });
    nv.utils.windowResize(chart.update);
    return chart;
});
